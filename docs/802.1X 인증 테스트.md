# 802.1X + FreeRADIUS 동적 VLAN 할당 트러블슈팅 로그 (EVE-NG)

> 목표: **Windows 클라이언트(802.1X Supplicant)**가 인증에 성공하면 **VLAN 810으로 동적 할당**되고, 해당 VLAN의 DHCP 풀에서 IP를 받아 통신되는 흐름을 검증한다.

---

## 오늘 한 줄 요약

- **DHCP(동적 VLAN 810 대역) IP 할당/통신은 정상화 완료**
- **802.1X 인증은 Access Switch(Authenticator) ↔ RADIUS 서버 통신 단계에서 막힘**
- 설정 미스라기보다 **EVE-NG에서 사용하는 스위치 이미지(IOSvL2)의 Control Plane 제약**으로 보이며, 그래서 **진행이 멈춘 상태**

---

## 1) 실습 환경

### 구성 요소
- **RADIUS/DHCP 서버**: Ubuntu (FreeRADIUS 3.x + ISC DHCP)
- **Distribution / L3 역할**: DSW1 (SVI 기반 VLAN 라우팅)
- **Access Switch(Authenticator)**: ASW2 (IOSvL2)
- **클라이언트**: Windows (EVE-NG/QEMU)

### VLAN / IP 요약
| 구분 | VLAN | 대역 | 게이트웨이(예시) | 비고 |
|---|---:|---|---|---|
| RADIUS 서버망 | 100 | `10.0.10.0/28` | `10.0.10.1` | RADIUS 서버 `10.0.10.11/28` |
| 스위치 관리망 | 110 | `10.0.11.0/28` | `10.0.11.1` | ASW2 SVI `10.0.11.5/28` |
| 동적 할당(User) | 810 | `192.168.81.0/28` | `192.168.81.1` | DHCP 서버 `192.168.81.11` (서브인터페이스 `ens4.810` 기준) |
| Fail/No-Response 격리망 | 500 | (실습용) | - | 인증 실패 시 임시 VLAN |

> 오늘 핵심 이슈는 **ASW2(10.0.11.5)에서 RADIUS 서버(10.0.10.11)로의 L3 통신이 성립하지 않는 것**이었다.

---

## 2) 사전 작업: VLAN 810 DHCP 할당 검증

### 증상
- Windows 클라이언트가 IP를 못 받아서 **APIPA(169.254.x.x)**가 잡히거나, DHCP가 불안정했다.

### 확인 1 — DHCP 서비스가 죽어있음
- `isc-dhcp-server` 상태가 `failed`로 확인됨

<img width="915" height="614" alt="01_dhcp_service_failed" src="https://github.com/user-attachments/assets/8c613e18-506d-4fc6-bf8e-6a5e15528d60" />


### 확인 2 — DHCP 설정 문법 점검
- 문법 자체는 통과(`dhcpd -t`)

<img width="585" height="176" alt="02_dhcpd_syntax_check" src="https://github.com/user-attachments/assets/2262f31a-482b-428a-bf34-02ba6da8ff58" />


### 확인 3 — dhcpd.conf 서브넷/옵션 확인

<img width="714" height="528" alt="03_dhcpd_conf_subnet" src="https://github.com/user-attachments/assets/4ade8593-af9c-4916-ae57-945f22e0918f" />


### 조치 — DHCP 서비스 재기동 후 정상 동작

<img width="917" height="584" alt="04_dhcp_service_running" src="https://github.com/user-attachments/assets/939a60c4-6557-4a75-bf30-2f4fb499d66b" />


### 검증 — Windows가 정상 IP 할당

<img width="1028" height="839" alt="05_windows_dhcp_ipconfig" src="https://github.com/user-attachments/assets/df292614-3926-4d3d-9840-00e6233390b0" />


### 추가 검증 — ARP / ping / 스위치 MAC·ARP 테이블

- Windows ARP 확인

<img width="550" height="338" alt="06_windows_arp" src="https://github.com/user-attachments/assets/59e90c48-e968-4b49-848e-c5e05f43fce2" />


- DSW1에서 VLAN810 단말 MAC/ARP 확인

<img width="815" height="383" alt="07_dsw1_vlan810_mac_arp" src="https://github.com/user-attachments/assets/2084dda8-d471-44d3-aa30-19dca6fe6083" />


- Windows `ipconfig /all`로 DHCP 서버/게이트웨이 확인

<img width="620" height="509" alt="08_windows_ipconfig_all" src="https://github.com/user-attachments/assets/8aaf589b-f4b7-4cc6-9c0e-d817ebe0491d" />


- 게이트웨이 핑 성공

<img width="448" height="234" alt="09_windows_ping_gateway" src="https://github.com/user-attachments/assets/b4e6ca0f-51c2-465f-98fb-7fb40ab770ca" />


- 서버 측 `tcpdump`로 VLAN810 DHCP 트래픽이 실제로 들어오는지 확인

<img width="822" height="590" alt="10_tcpdump_vlan810_dhcp" src="https://github.com/user-attachments/assets/b9bd2280-722f-4e9c-8049-35563ad85241" />


> 결론: **VLAN810 자체(DHCP·L2/L3)는 정상 동작**까지는 확보했다.

---

## 3) 802.1X 인증 테스트 시작

### 서버 로그 모니터링 준비

<img width="1037" height="852" alt="11_tail_syslog_radiuslog" src="https://github.com/user-attachments/assets/5919dacc-a522-4af8-be0d-6bb0c2821a42" />


- (예시) 
  - `sudo tail -f /var/log/syslog`
  - `sudo tail -f /var/log/freeradius/radius.log`

### FreeRADIUS: NAS(Client) 등록
- `clients.conf`에 ASW2를 RADIUS Client로 등록

<img width="941" height="393" alt="12_freeradius_clients_conf" src="https://github.com/user-attachments/assets/41bd2ce6-7362-4b60-8f6f-72d81b9c8297" />


> 여기서 설정한 `secret`은 **스위치의 RADIUS key**와 1:1로 일치해야 한다.

### 스위치(ASW2): AAA / 802.1X 적용 후 실패 로그 확인

<img width="843" height="530" alt="13_asw2_aaa_and_fail_log" src="https://github.com/user-attachments/assets/81c18f73-9ba7-4064-8c8d-0245c2255cce" />


### Windows: "인증 시도 중" 상태가 계속됨

<img width="1043" height="838" alt="15_windows_authenticating" src="https://github.com/user-attachments/assets/d6040078-b6d4-4e26-a474-ea9979d71e00" />


- 네트워크 상태가 계속 **"인증 시도 중"**으로 머물렀고,
- 특정 시점에는 Windows 보안 로그인 창이 떠서 사용자/암호를 요구했다.

<img width="1044" height="842" alt="16_windows_8021x_login_prompt" src="https://github.com/user-attachments/assets/3058516f-e872-4a03-90c5-034c0ed0df19" />


### FreeRADIUS: 테스트 계정 및 VLAN 810 동적 할당 속성

<img width="891" height="409" alt="17_freeradius_users_vlan810" src="https://github.com/user-attachments/assets/6997151c-2e82-4e3a-a576-c51c83e64bd6" />


- 위 설정 기준으로는 Windows 로그인 창에서 아래처럼 입력하는 것이 정상 플로우
  - 사용자: `haru`
  - 암호: `haru123`

---

## 4) 현상 심화: RADIUS 요청 타임아웃

### 스위치 로그: RADIUS Dead/Alive + DOT1X/MAB 실패 반복

<img width="980" height="516" alt="14_asw2_radius_dead_alive" src="https://github.com/user-attachments/assets/99f0b59e-f58e-45ab-a621-c40b9a89a725" />


(추가 스니펫)

<img width="987" height="84" alt="24_asw2_radius_dead_alive_snippet" src="https://github.com/user-attachments/assets/a8f9b168-3a1d-4aba-b7ab-167a823b93e9" />


### 스위치 디버그: Access-Request는 보내는데, 응답이 안 옴

<img width="1020" height="1204" alt="21_asw2_debug_radius_timeout" src="https://github.com/user-attachments/assets/50d378b6-6689-45af-863a-425a4a7dab7a" />


관찰 포인트:
- `Send Access-Request to 10.0.10.11:1812`
- 이후 `Request timed out!` → 재전송 반복 → 최종 `No response from ...`

이 시점부터 **“인증 실패”가 아니라 “서버와 통신 자체가 안 되는 상태”**로 판단했다.

---

## 5) 서버 측 점검: FreeRADIUS가 실제로 열려있는가?

### FreeRADIUS가 UDP 1812/1813을 LISTEN 중인지 확인

<img width="888" height="390" alt="19_radius_listening_ports" src="https://github.com/user-attachments/assets/f83d567b-f7fa-4633-9d47-128d86e8505e" />


- FreeRADIUS는 정상적으로 포트를 열고 있었다.

### FreeRADIUS -X 실행 시 빨간 메시지

<img width="920" height="297" alt="18_freeradius_debug_bind_error" src="https://github.com/user-attachments/assets/698d2e76-87f6-4012-bed5-c9b8751bbb4f" />


이 메시지는 **이미 freeradius 서비스가 실행 중인데(-X는 foreground 디버그)**,
`inner-tunnel`이 사용하는 로컬 포트(예: 18120)를 또 바인딩하려 해서 발생한 현상이었다.

- 디버그 모드로 보려면 보통 아래 순서가 안전하다.

```bash
sudo systemctl stop freeradius
sudo freeradius -X
# (디버그 종료 후)
sudo systemctl start freeradius
```

### 서버 인터페이스/대역 확인

<img width="921" height="358" alt="20_radius_server_ip_addr" src="https://github.com/user-attachments/assets/f4ac4299-f18b-41fc-aa2c-9706d8f5d530" />


- RADIUS 서버 IP가 `10.0.10.11/28`로 구성되어 있고,
- DSW1에서도 `10.0.10.0/28`이 직접 연결(connected)로 잡혀 있는 것을 확인했다.

<img width="768" height="132" alt="23_dsw1_route_to_radius" src="https://github.com/user-attachments/assets/b3eed082-53c5-4909-a592-91f083ceb7c8" />


> 여기까지 보면, “DSW1 ↔ RADIUS 서버” 구간은 정상이다.

---

## 6) 결정적 단서: ASW2(L2)에서 서버로 L3 통신이 성립하지 않음

### ASW2 SVI/게이트웨이 상태

<img width="752" height="291" alt="22_asw2_vlan110_ping_gateway" src="https://github.com/user-attachments/assets/dee9cd92-c474-4d0a-950e-24652c0ddb6a" />


- ASW2의 관리 SVI(VLAN110)는 정상(10.0.11.5/28)
- `ping 10.0.11.1`(default-gateway 역할)은 성공

하지만,
- **`ping 10.0.10.11 source vlan110`은 실패**
- 서버 측 `tcpdump`에도 **RADIUS 패킷이 아예 안 찍힘**

즉, 스위치 로그상으로는 Access-Request를 “보냈다”고 하는데,
실제로는 **ASW2 Control Plane에서 외부 VLAN(10.0.10.0/28)로 패킷이 나가지 못하는 상태**로 보였다.

### 오늘의 결론(가설)
- 실장비(예: Catalyst 2960)에서는 **L2 스위치도 Authenticator로 동작**하며 RADIUS 통신을 수행한다.
- 그런데 EVE-NG의 **IOSvL2(또는 vIOS-L2 계열)**는 기능이 제한되어,
  - **Control Plane에서 UDP/TCP/RADIUS 생성/포워딩이 제약**되거나
  - SVI/ping source/기본 게이트웨이 처리에 제한이 있어
  - 결과적으로 **RADIUS 서버와 통신이 끊기는 현상**이 발생한 것으로 추정된다.

---

## 7) 스위치 포트 설정(오늘 사용한 형태)

> PC 랜선을 뽑았다 꼽기 어려워서, 필요 시 **포트 `shutdown` / `no shutdown`**으로 인증 재시도 트리거를 걸 계획이었다.

```cisco
interface Gi0/0
 description ## Dot1x Auth Port ##
 switchport mode access
 authentication order dot1x mab
 authentication priority dot1x mab
 authentication port-control auto
 authentication event no-response action authorize vlan 500
 authentication event fail action authorize vlan 500
 dot1x pae authenticator
 mab
 spanning-tree portfast
 spanning-tree bpduguard enable
```

---

## 8) 정리

1. **인증 실패(REJECT)**와 **통신 실패(TIMEOUT)**는 완전히 다른 문제다.
   - 오늘 케이스는 서버 정책 문제가 아니라, **RADIUS 패킷이 서버까지 도달하지 않는 문제**였다.
2. 스위치 쪽은 `debug radius authentication` 한 장으로도 방향이 잡힌다.
   - `Access-Request` → `Request timed out` 반복이면, 인증서/계정이 아니라 **네트워크/제어플레인**부터 보게 된다.
3. `freeradius -X`는 서비스와 **동시에 실행하면 포트 충돌**이 날 수 있다.
   - `systemctl stop` 후 실행이 안전했다.

---

## 9) 여기서부터가 고민: EVE-NG 제약 때문에 진행이 멈춤

오늘 상태로는 **ASW2(IOSvL2)를 Authenticator로 두고**,
**서로 다른 VLAN(110 ↔ 100) 사이로 RADIUS 통신을 태우는 구성이 안 돌아간다**는 결론에 가까웠다.

그래서 다음 옵션들을 고민 중이다.

### 옵션 A) Authenticator(ASW2) 관리 IP를 RADIUS 서버망으로 붙이기 (우회)
- ASW2 관리 SVI를 `10.0.10.0/28` 쪽으로 구성하거나,
- RADIUS 서버에 `10.0.11.0/28` 인터페이스를 추가해서
- **L3 라우팅 없이 같은 서브넷에서 RADIUS 통신이 되게 만드는 방식**

> 장점: 지금 구성 유지하면서 가장 빨리 다음 단계로 넘어갈 수 있음

### 옵션 B) Authenticator 이미지를 교체 (실장비급 스위치 이미지)
- IOSvL2 대신 **RADIUS/802.1X를 더 제대로 지원하는 스위치 이미지**(예: Catalyst 9000v 계열 등)로 교체

> 단점: 이미지 용량/리소스가 크고, 환경 구축 난이도/라이선스 이슈 가능성

### 옵션 C) IOL L2로 ASW/DSW를 대체
- IOL L2가 더 가볍고(리소스 효율적), 기능 지원 폭이 다를 수 있어 고려 중

> 다만, 오늘 확인한 것처럼 **IOL L3는 SVI 기반 학습 흐름과 맞지 않는 부분이 있어**(라우터 느낌) 아키텍처 재조정이 필요할 수 있음

---
