# EVE-NG 실습 기록: 802.1X(PEAP/MSCHAPv2) + FreeRADIUS + VLAN 810 동적할당 + DHCP

> 목표: **Access Switch(Authenticator) 포트 기반 802.1X 인증 성공 → VLAN 810 동적 할당 → DHCP IP 수령**

---

## 1) 실습 환경

### 구성 요소
- **RADIUS/DHCP 서버 (Linux)**: `10.0.10.11/28`  
  - FreeRADIUS 3.x
  - ISC DHCP Server (`isc-dhcp-server`)
- **DSW (L3 스위치)**: SVI 기반 Inter-VLAN Routing
  - VLAN100: `10.0.10.1/28`
  - VLAN110: `10.0.11.1/28`
- **ASW (Authenticator)**: viosl2-adventerprisek9-m.SSA.high_iron_20200929
  - 관리 IP: `10.0.11.5/28` (VLAN110)
  - `ip default-gateway 10.0.11.1`
  - RADIUS 소스 인터페이스: `ip radius source-interface Vlan110` (예정/적용)

### 목표 VLAN
- **VLAN 810 (Auth_Service)**: 802.1X 인증 성공 시 **동적 할당**
- 인증 성공 이후 단말은 DHCP로 IP 수령 (예: `192.168.81.15/24`, GW `192.168.81.1`)
  - 인증 성공/할당 결과는 아래 증빙 스크린샷 참고

---

## 2) 핵심 포인트(먼저 잡고 간 것)

### 2-1. ASW에서 `ip routing` 상태에 따른 관리 경로 이슈
- **ASW2에서 `ip routing`이 켜져 있으면 `ip default-gateway`가 무시**되는 동작을 확인.
- `no ip routing` 적용 후:
  - ASW → DSW 다른 서브넷(예: `10.0.10.1`) ping 성공
  - ASW Control Plane 기준 L3 통신 정상화
- 결론: ASW의 RADIUS(UDP 1812/1813) 통신은 **가능한 상태**로 판단하고 다음 단계로 진행.

---

## 3) 802.1X 인증 테스트 트러블슈팅 로그

아래는 “이상 징후 → 원인 후보 → 조치 → 검증” 흐름으로 정리한 기록입니다.

### 3-1. FreeRADIUS에서 BlastRADIUS 관련 경고 발생

#### 증상
- FreeRADIUS 로그에 **BlastRADIUS check** 관련 메시지가 출력.
- `require_message_authenticator` 관련 권고가 함께 나옴.

<img width="916" height="366" alt="8021x_01" src="https://github.com/user-attachments/assets/5e65839e-400a-435c-88d1-a255fa7955d4" />


**클라이언트 정의(clients.conf) 확인**
- ASW를 RADIUS client로 등록할 때, 소스 IP가 정확히 매칭되어야 합니다(이번 환경: `10.0.11.5`).
- 실습 중에는 `require_message_authenticator = no` 로도 진행했지만, 보안 경고를 줄이려면 `true`로 맞추는 편이 권장됩니다.

<img width="933" height="581" alt="8021x_02" src="https://github.com/user-attachments/assets/c7b6f23e-b791-4c42-b8c8-0b8030b51551" />


추가로 Proxy-State 관련 경고도 함께 출력되는 것을 확인했습니다.

<img width="820" height="187" alt="8021x_04" src="https://github.com/user-attachments/assets/c717e13c-c7d6-426a-b507-ec95a4b6f34b" />


#### 해석(의미)
- 최근 RADIUS 구현들은 BlastRADIUS류 공격 완화를 위해 **Message-Authenticator(특히 EAP/Proxy 관련 변조 방지)**를 더 엄격히 요구하는 방향으로 바뀜.
- FreeRADIUS는 클라이언트 정의에 따라:
  - `require_message_authenticator = true` : Message-Authenticator 없으면 **즉시 Drop/Reject**
  - `require_message_authenticator = no` : 없더라도 허용(보안 강도 낮아짐)

#### 실습에서의 실제 영향
- 이번 케이스에서 “거부(Reject)”의 직접 원인은 BlastRADIUS 설정이 아니라,
  - **MAB로 들어온 요청(= EAP 미포함)** 이었고,
  - 사용자 인증 타입이 잡히지 않아(`No Auth-Type found`) Reject로 떨어진 것이 핵심이었음(아래 3-3 참고).

---

### 3-2. FreeRADIUS 디버그(-X) 실행이 안 됨 (포트 점유)

#### 증상
- `freeradius -X` 실행 시 `inner-tunnel` 포트(예: `127.0.0.1:18120`)가 이미 사용 중이라 실패.

<img width="918" height="108" alt="8021x_03" src="https://github.com/user-attachments/assets/272c7cbc-67e7-46ff-a7cf-04e32c58156b" />


#### 조치
- 이미 실행 중인 FreeRADIUS 프로세스를 내려서 포트를 비워야 함.

```bash
# 1) 서비스로 떠 있는 경우 (일반적)
sudo systemctl stop freeradius

# 2) 혹시 잔존 프로세스가 있으면 확인 후 종료
ps -ef | grep -E 'freeradius|radiusd'
sudo pkill -f freeradius

# 3) 포트 점유 확인(선택)
sudo ss -lntup | egrep '1812|1813|18120'

# 4) 디버그 모드로 실행
sudo freeradius -X
```

#### 검증
- `Ready to process requests` 상태에서 Access-Request 수신 로그가 출력되면 정상.

---

### 3-3. Reject의 진짜 원인: MAB 요청이 먼저 들어옴(= EAP 없음)

#### 증상
- 스위치/FreeRADIUS에서 Access-Request는 도착하는데, 계속 **Access-Reject**
- FreeRADIUS -X에서 다음 특징이 관찰됨:
  - `method=mab`
  - `User-Name`이 사람 계정이 아니라 숫자(= MAC 기반) 형태
  - `eap: No EAP-Message, not doing EAP`
  - `No Auth-Type found: rejecting the user`

<img width="869" height="398" alt="8021x_09" src="https://github.com/user-attachments/assets/dafee098-69ba-41ba-b5e0-eb9508147ea0" />

<img width="924" height="505" alt="8021x_10" src="https://github.com/user-attachments/assets/fa157ddc-30a4-4bf8-8b68-959895b91ebe" />


(동일 상황에서 PAP 경고 + Auth-Type 미지정으로 Reject 되는 화면도 확인)

<img width="876" height="268" alt="8021x_05" src="https://github.com/user-attachments/assets/20fc0222-c690-4bf4-96ca-2a3edfef48fc" />

<img width="920" height="434" alt="8021x_11" src="https://github.com/user-attachments/assets/64ee2020-a0e4-44af-a094-f86104b6095c" />


또한 스위치 디버그에서도 동일하게 **method=mab**가 찍힘.

<img width="854" height="1062" alt="8021x_07" src="https://github.com/user-attachments/assets/f82fa167-338e-4b94-a971-f6dbcebe2c8c" />


#### 왜 이런 일이 생기나?
- 포트에 `authentication order dot1x mab` 를 넣어두면,
  - 단말이 802.1X(EAPOL) 시작을 늦게 하거나,
  - dot1x 협상이 실패/타임아웃되면,
  - 스위치가 **MAB(MAC Authentication Bypass)** 로 fallback을 시도할 수 있음.
- MAB는 “사용자 ID/비밀번호”가 아니라 **단말 MAC을 ID처럼 사용**해서 RADIUS에 질의함.
  - 그래서 FreeRADIUS `users`/`authorize` 파일에 해당 MAC에 대한 인증 타입이 없으면 Reject가 정상.

#### 조치 옵션
- **(권장) dot1x만 통과시키고 싶다면:** MAB를 제거/비활성화
  - dot1x 최소 설정만 두는 방식
- **MAB도 허용하고 싶다면:** RADIUS에 MAC 기반 계정을 따로 정의(예: users 파일에 MAC 계정/패스워드 정책)

---

### 3-4. FreeRADIUS 계정/동적 VLAN(810) 정책 확인

#### 계정 정책(실습에서 사용한 users 파일)
- `test01`: 단순 인증 테스트용
- `haru`: 인증 성공 시 VLAN 810을 내려주도록 Tunnel Attribute 세팅

<img width="528" height="200" alt="8021x_06" src="https://github.com/user-attachments/assets/6ded2d78-cc1c-48ca-a57e-458f3ea1267c" />


**중요:**
- Windows에서 PEAP/MSCHAPv2로 로그인할 때는, 결국 RADIUS가 보는 “사용자 이름”이 `haru` 같은 **실제 계정 문자열**이어야 VLAN 정책이 정상 적용됨.
- 위 Reject 구간에서는 `User-Name="500000080000"` 처럼 **MAC 기반(MAB)** 이 들어와서, `haru` 정책과 매칭될 수 없었음.

---


### 3-5. 성공: dot1x(PEAP/MSCHAPv2) 인증 → VLAN 810 동적 할당 → DHCP IP 수령

#### FreeRADIUS 측(성공 흐름)
- Access-Request가 `method=dot1x`로 들어오고, EAP/PEAP 협상이 진행됨.

<img width="902" height="509" alt="8021x_15" src="https://github.com/user-attachments/assets/b89fa3dc-bab0-442e-8b0b-e852d1be6660" />

<img width="915" height="420" alt="8021x_16" src="https://github.com/user-attachments/assets/9afe417c-80ab-471c-a3ae-961b250a8f8a" />


인증 세션 상태에서도 dot1x가 정상 동작 중(Running)으로 확인됨.

<img width="394" height="113" alt="8021x_08" src="https://github.com/user-attachments/assets/f3f073b4-7355-43fd-8201-88c08ec6da92" />


#### 스위치 측(동적 VLAN 810 할당 확인)
- VLAN 810(Auth_Service)에 포트가 붙은 것이 확인됨.

<img width="640" height="24" alt="8021x_17" src="https://github.com/user-attachments/assets/ca793612-09ea-4783-9b2c-ca65332bc5f8" />


FreeRADIUS에서는 Accounting/Interim-Update 로그로 **VLAN-ID=810** 및 단말 IP가 함께 확인됩니다.

<img width="637" height="422" alt="8021x_18" src="https://github.com/user-attachments/assets/d3cf8ea6-6bea-49d4-92e5-c77fdad0757e" />


#### 단말 측(DHCP IP 수령 확인)
- 단말이 VLAN 810 대역으로 DHCP를 받고, GW를 정상 수신.

<img width="549" height="331" alt="8021x_14" src="https://github.com/user-attachments/assets/9927745f-5704-4d7f-91d7-bc6c96815392" />


#### DHCP 서버 로그(DHCPACK) 확인
- DHCPREQUEST/DHCPACK 로그가 남음.

<img width="928" height="94" alt="8021x_22" src="https://github.com/user-attachments/assets/34cbb7eb-b729-4135-9d4a-8356133cd26e" />


> 참고: 스위치에서 `debug radius authentication`를 켜면, 인증 성공 이후에도 EAP 교환/Accounting 등으로 **로그가 한참 동안 쏟아질 수 있습니다**(정상 동작).
> 필요 시 테스트 후에는 `undebug all`로 끄는 편이 안전합니다.

<img width="928" height="94" alt="8021x_22" src="https://github.com/user-attachments/assets/dc2d040b-c528-4ef9-8ec6-562b7dd53700" />


#### 추가 검증
- 단말에서 서버로 ping 성공(라우팅/정책 동작 확인).

<img width="538" height="238" alt="8021x_20" src="https://github.com/user-attachments/assets/bd0c009b-7ac0-4ca9-bf00-b557e9792190" />


---

### 3-6. “다시 인증이 언제 일어나는가?”(포트 다운/업, 단말 재부팅)

#### 관찰 1) 포트를 `shutdown` 하면 VLAN 할당은 즉시 사라짐
- 포트가 내려가면 VLAN 810에서 해당 포트가 빠지는 것이 확인됨.

<img width="992" height="549" alt="8021x_19" src="https://github.com/user-attachments/assets/994e67c2-0d13-43d8-95f2-0efa2a8b94c8" />


#### 관찰 2) 그런데 단말 IP는 바로 안 바뀜
- 이유는 단말 OS가 **링크 상태/어댑터 상태 변화를 즉시 “끊김”으로 처리하지 않거나**,  
  가상 환경(EVE-NG/가상 NIC)에서는 이벤트 전달이 지연되는 경우가 있기 때문.
- 물리 환경이면 보통 링크 다운 이벤트로 바로 재협상이 시작되지만,  
  EVE-NG에서는 “전원 OFF/ON”이 가장 확실하게 초기화/재인증 트리거가 됨.

---

### 3-7. dot1x 타이머 설정

다음 값들은 “EAPOL 요청/재요청” 및 “인증 대기 시간”을 빠르게 잡기 위해 자주 조정합니다.

- `dot1x timeout tx-period 2`
  - EAPOL-Request/Identity(또는 관련 프레임)를 **2초 주기**로 재전송
- `dot1x max-req 1`
  - 초기 요청을 **최대 1회까지만** 시도(실패 판단을 빠르게)
- `dot1x max-reauth-req 3`
  - 재인증(reauth) 구간에서 요청을 **최대 3회** 재시도
- `dot1x timeout auth-period 2`
  - 인증 상태 머신이 다음 단계로 넘어가기 전 대기(타임아웃) 값을 **2초**로

---
