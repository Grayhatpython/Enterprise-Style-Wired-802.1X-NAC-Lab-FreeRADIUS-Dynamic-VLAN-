# SystemEvents(DHCPACK) → radius.dhcp_log 자동 적재 (rsyslog + MySQL Trigger)

> **목표**: 시스템에서 발생한 DHCPACK 로그가 `/var/log/syslog`에 기록되면, `rsyslog(ommysql)`가 이를 **MySQL `Syslog.SystemEvents`** 테이블에 적재하고, 이후 **Trigger**가 `Message` 컬럼에서 DHCPACK 정보를 파싱해 **`radius.dhcp_log`** 테이블에 자동으로 정규화 저장한다.

- 참고: 이 문서는 **실습 당시 시점의 상태**를 기록한 것으로, 환경 변경(패키지/설정/인터페이스 이름/DB명)에 따라 일부 값은 달라질 수 있다.

---

## 0. 전체 흐름(아키텍처)

1) `dhcpd`가 DHCPACK 로그를 syslog로 출력
2) `/var/log/syslog`에 로그 기록
3) `rsyslog`가 `ommysql` 모듈로 MySQL에 INSERT
4) `Syslog.SystemEvents.Message`에 DHCPACK 로그가 쌓임
5) `AFTER INSERT` Trigger가 `NEW.Message`를 파싱
6) `radius.dhcp_log`에 `logtime/ipaddr/macaddr/hostname/vlanid/message` 정규화 저장

---

## 1. 실습 환경(버전/전제)

- MySQL: `8.0.44-0ubuntu0.24.04.2`
- `log_bin`: ON (바이너리 로그 활성화)
- rsyslog: v8.2312.0 (로그에서 확인)

<img width="663" height="552" alt="01_mysql_version_grants_binlog" src="https://github.com/user-attachments/assets/0fd596e9-33ba-46f2-96b6-799a2be5fb54" />


> DB 이름은 환경에 따라 `Syslog`(대문자 S) 또는 `syslog`로 존재할 수 있다.
> 아래 예시는 `Syslog` 기준으로 작성했으며, 본인 환경에 맞춰 DB명을 치환하면 된다.

---

## 2. (선행) rsyslog → MySQL 적재 파이프라인 확인

### 2.1 MySQL 소켓 경로 확인

```bash
sudo mysql -e "SHOW VARIABLES LIKE 'socket';"
```

예시:

<img width="808" height="367" alt="10_check_mysql_socket_and_rsyslog_conf" src="https://github.com/user-attachments/assets/8f3c5fa2-9e1f-48d0-9148-4515991a61d9" />


### 2.2 rsyslog ommysql 설정 확인

`/etc/rsyslog.d/mysql.conf` (예시)

```conf
module(load="ommysql")
*.* action(type="ommysql" server="localhost" db="Syslog" uid="rsyslog" pwd="<PASSWORD>")
```

- `uid/pwd`는 **MySQL 사용자 계정**과 정확히 일치해야 한다.
- `server="localhost"`는 환경에 따라 **소켓 접속**이 될 수 있다.
  - 소켓 경로 이슈가 반복되면 `127.0.0.1`로 TCP 접속 강제(권장).

### 2.3 MySQL 사용자/권한(예시)

> rsyslog가 MySQL에 INSERT 해야 하므로, 최소 권한은 `Syslog.*`에 대한 INSERT(및 필요한 경우 SELECT)이다.

```sql
-- 예시: rsyslog가 localhost로 접속하는 경우
CREATE USER IF NOT EXISTS 'rsyslog'@'localhost' IDENTIFIED BY '<PASSWORD>';
GRANT INSERT, SELECT ON Syslog.* TO 'rsyslog'@'localhost';
FLUSH PRIVILEGES;
```

Host 매칭 관련 메모:
- `rsyslog@10.0.30.5` 와 `rsyslog@10.0.30.%` 는 **서로 다른 계정**이다.
- MySQL Host 패턴은 `*` 가 아니라 `%` 를 사용한다.

<img width="581" height="263" alt="03_create_users_and_grants_rsyslog" src="https://github.com/user-attachments/assets/82105eaf-8238-43fa-a195-2a779c7e2246" />


<img width="668" height="610" alt="04_show_grants_rsyslog_hosts" src="https://github.com/user-attachments/assets/09262d34-8b60-4a91-a2f1-11a6dded0552" />


---

## 3. 트리거 연습(개념 확인)

Trigger에서 `NEW/OLD` 사용 가능 여부, `DELIMITER` 사용, `IFNULL/STR_TO_DATE` 동작 등을 간단 테이블로 먼저 확인했다.

<img width="942" height="558" alt="02_trigger_basics_employee_test" src="https://github.com/user-attachments/assets/ce78d1c8-97bf-4549-b98f-c62f9897ab0c" />

> 포인트
> - Trigger 본문에 `;`가 여러 개 들어가므로 `DELIMITER $$` 같은 구분자 변경이 필요
> - `IFNULL(a, b)`는 **a가 NULL이면 b를 사용**한다.

---

## 4. DHCPACK 로그 샘플 (파싱 대상)

`/var/log/syslog`에 남는 DHCPACK 로그는 아래 형태를 기준으로 했다.

<img width="808" height="51" alt="06_sample_dhcpack_log_line" src="https://github.com/user-attachments/assets/93c00e23-2b82-46f1-b655-572da720fe4e" />


예시:
```
... dhcpd[2837]:  DHCPACK on 10.0.31.15 to 50:00:00:06:00:00 (DESKTOP-PAGBPVM) via ens4.310
```

- `DHCPACK on <ip> to <mac> (<hostname>) via ensX.<vlan>`
- 인터페이스: `ens3`, `ens4` 계열
- VLAN 서브인터페이스: 실습에서는 `100~900` 범위를 허용

---

## 5. radius.dhcp_log 테이블 준비

> 목적: `SystemEvents.Message` 원문에서 필요한 필드를 추출해 정규화 저장

예시 스키마:

```sql
CREATE TABLE IF NOT EXISTS radius.dhcp_log (
  id        BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  logtime   DATETIME        NOT NULL,
  ipaddr    VARCHAR(20)     DEFAULT NULL,
  macaddr   VARCHAR(20)     DEFAULT NULL,
  hostname  VARCHAR(50)     DEFAULT NULL,
  vlanid    INT             DEFAULT NULL,
  message   TEXT            NOT NULL,
  PRIMARY KEY (id)
);
```

---

## 6. 핵심: SystemEvents → radius.dhcp_log 트리거 생성

### 6.1 자주 터지는 문법 포인트(실제 발생)

- `IF ... THEN` 에서 **THEN 누락** 시 문법 에러
- 스키마/테이블 명을 작은따옴표(')로 감싸면 안 됨 → **백틱(`)** 사용
- DB명이 `Syslog` 인데 `syslog`로 쓰면 Linux 환경에서 실패할 수 있음(대소문자)

<img width="955" height="580" alt="07_trigger_create_syntax_error" src="https://github.com/user-attachments/assets/99f16e77-c6ed-44f3-9627-0016ab9d3ae1" />


### 6.2 최종 트리거(가독성 버전)

아래는 **정리된 최종본**이다.

> 주의
> - `Syslog.SystemEvents` / `NEW.Message` / `NEW.ReceivedAt` 컬럼명은 본인 DB에 맞게 확인
> - VLAN 범위(100~900)는 필요에 따라 수정

```sql
DELIMITER $$

CREATE TRIGGER ai_systemevents_dhcp_to_radius_dhcp_log
AFTER INSERT ON `Syslog`.`SystemEvents`
FOR EACH ROW
BEGIN
  DECLARE d_ipaddr   VARCHAR(20) DEFAULT NULL;
  DECLARE d_macaddr  VARCHAR(20) DEFAULT NULL;
  DECLARE d_hostname VARCHAR(50) DEFAULT NULL;
  DECLARE d_vlanid   INT DEFAULT NULL;

  -- DHCPACK 라인만 필터
  IF NEW.Message REGEXP 'DHCPACK on [0-9.]+ to [0-9A-Fa-f:]+.* via ens[0-9]+\\.[0-9]{1,3}\\b' THEN

    -- IP: "DHCPACK on <ip> to"
    SET d_ipaddr = SUBSTRING_INDEX(
      SUBSTR(NEW.Message, LOCATE('DHCPACK on ', NEW.Message) + CHAR_LENGTH('DHCPACK on ')),
      ' ',
      1
    );

    -- MAC: "to <mac> ("
    SET d_macaddr = SUBSTRING_INDEX(
      SUBSTR(NEW.Message, LOCATE('to', NEW.Message) + 3),
      ' ',
      1
    );

    -- Hostname: "(<hostname>)" 가 있으면 추출
    SET d_hostname = IF(
      LOCATE('(', NEW.Message) = 0,
      '',
      SUBSTRING_INDEX(SUBSTR(NEW.Message, LOCATE('(', NEW.Message) + 1), ')', 1)
    );

    -- VLAN: "... via ensX.<vlan>" 에서 마지막 '.' 뒤
    SET d_vlanid = CAST(SUBSTRING_INDEX(NEW.Message, '.', -1) AS UNSIGNED);

    -- VLAN 범위 필터(100~900) 조건이 있다면
    IF d_vlanid BETWEEN 100 AND 900 THEN
      INSERT INTO `radius`.`dhcp_log` (logtime, ipaddr, macaddr, hostname, vlanid, message)
      VALUES (NEW.ReceivedAt, d_ipaddr, d_macaddr, d_hostname, d_vlanid, NEW.Message);
    END IF;

  END IF;
END$$

DELIMITER ;
```

<img width="937" height="281" alt="08_trigger_created_ok" src="https://github.com/user-attachments/assets/61eff408-f5b7-46dc-b75b-b6a8a0c1cb32" />


---

## 7. 검증 방법

### 7.1 SystemEvents에 DHCPACK이 적재되는지 확인

```sql
SELECT ReceivedAt, Message
FROM `Syslog`.`SystemEvents`
WHERE Message LIKE '%DHCPACK on%'
ORDER BY ReceivedAt DESC
LIMIT 20;
```

### 7.2 radius.dhcp_log에 자동 삽입되는지 확인

```sql
SELECT id, logtime, ipaddr, macaddr, hostname, vlanid, message
FROM `radius`.`dhcp_log`
ORDER BY logtime DESC
LIMIT 20;
```

성공 예시:

<img width="2074" height="832" alt="12_success_radius_dhcp_log_and_client_ip" src="https://github.com/user-attachments/assets/25c9393e-45de-40d4-a5f4-4c6eb372fac7" />


---

## 8. 트러블슈팅 로그 (문제 → 원인 → 해결)

### 8.1 rsyslog → MySQL 적재가 갑자기 멈춤 (`action suspended`)

**증상**
- `/var/log/syslog`에는 DHCPACK가 찍히는데
- `Syslog.SystemEvents`에는 더 이상 INSERT 되지 않음
- rsyslog 로그에 `ommysql ... suspended` 반복

<img width="835" height="630" alt="09_ommysql_socket_error_suspended" src="https://github.com/user-attachments/assets/1a65132c-3609-4ee4-80e7-3b52667142a5" />


**원인(대표)**
- MySQL 소켓 경로 불일치 / MySQL 서비스 재시작 타이밍
- rsyslog ommysql이 DB 접속 실패 후 action을 suspend

**해결**
1) MySQL 소켓 확인
2) `/etc/rsyslog.d/mysql.conf`의 `server/db/uid/pwd` 확인
3) rsyslog 재시작

```bash
sudo systemctl restart rsyslog
sudo journalctl -u rsyslog -b --no-pager | grep -iE "mysql|ommysql|suspend|error|failed"
```

### 8.2 `Access denied for user 'rsyslog'@'localhost'` (1045)

**증상**
- rsyslogd 로그에 1045 Access denied

<img width="815" height="137" alt="11_ommysql_access_denied_1045" src="https://github.com/user-attachments/assets/6eb8fed6-5e8e-466c-84ec-124a797f6bb8" />


**원인**
- `/etc/rsyslog.d/mysql.conf`에 적힌 `pwd`와 MySQL 사용자 비밀번호 불일치
- 또는 Host 매칭(`rsyslog@localhost` vs `rsyslog@127.0.0.1`) 문제

**해결(예시)**
- 설정 파일의 `pwd`를 실제 비번으로 맞추거나
- MySQL 계정의 비밀번호를 설정 파일에 맞춤

```sql
ALTER USER 'rsyslog'@'localhost' IDENTIFIED BY '<PASSWORD>';
FLUSH PRIVILEGES;
```

---

### 8.3 `log_bin` 활성화 환경에서 Trigger/Function 생성 권한 이슈

**상황**
- `log_bin=ON` 상태에서, 환경에 따라 Trigger/Stored Function 생성 시 다음과 유사한 에러가 발생할 수 있다.
  - `You do not have the SUPER privilege and binary logging is enabled ...`
  - `Access denied; you need (at least one of) the SUPER or SYSTEM_VARIABLES_ADMIN privilege(s) for this operation`

**핵심 정리**
- `GRANT ALL PRIVILEGES ON radius.*`는 **스키마 내부 권한**이다. `SUPER`, `SYSTEM_VARIABLES_ADMIN` 같은 **글로벌 권한**은 별도로 관리된다.
- `log_bin_trust_function_creators`는 **GLOBAL 시스템 변수**라서 변경 시 관리자 권한이 필요하다.
- `SET GLOBAL ...`로 변경한 값은 보통 **재시작 전까지만 유지**된다(영구 반영은 MySQL 설정 파일에서).

<img width="569" height="216" alt="05_set_global_log_bin_trust_function_creators" src="https://github.com/user-attachments/assets/13b251d0-db31-46df-b354-269d35a21237" />


**체크/조치(예시)**

```sql
SHOW VARIABLES LIKE 'log_bin';
SHOW VARIABLES LIKE 'log_bin_trust_function_creators';
```

(관리자 계정에서)

```sql
SET GLOBAL log_bin_trust_function_creators = 1;
```

> 이번 트리거는 내장 문자열 함수만 사용하므로, 대부분 환경에서는 위 설정이 필수는 아니다.
> 다만 동일 랩을 재현할 때 흔히 만나는 권한 이슈라서 체크 포인트로 기록한다.
LIMIT 50;
```
